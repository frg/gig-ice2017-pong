<!DOCTYPE html>
<html>

<head>
    <title>iGC - ICE 2017</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>

<body>

    <div id="pong">
        <img class="header-logo" src="/assets/i-g-c-logo-header.png" alt="">
        <img class="header-logo header-logo-small" style="display: none" src="/assets/i-g-c-logo-header-small.png" alt="">
        <div id="menu" class="modal">
            <div class="modal-cell">
                <div class="modal-box">
                    <div class="modal-inner">
                        <button id="close-menu-btn" class="close-btn">âœ–</button>
                        <button id="singlep-menu-btn">Single Player</button>
                        <button id="twop-menu-btn" class="green-btn">2 Player</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="header-highscore">
            <span class="header-highscore-text">Highscore</span>
            <span class="header-highscore-score">0</span>
        </div>
    </div>

    <!--<div class="panel">
        Move with [ UP ], [ DOWN ]
    </div>-->

    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>-->
    <script src="/js/build.js"></script>

    <script type="text/javascript">
        /////////////////////////////////////////////////////
        // DON'T FORGET TO ENABLE WEBGL!! -- Jean
        // http://superuser.com/questions/836832/how-can-i-enable-webgl-in-my-browser
        /////////////////////////////////////////////////////

        console.info('Is WebGL available? ', (function webglAvailable() {
            try {
                var canvas = document.createElement("canvas");
                return !!
                    (window.WebGLRenderingContext &&
                        (canvas.getContext("webgl") ||
                            canvas.getContext("experimental-webgl")));
            } catch (e) {
                return false;
            }
        }()));

        Pong.prototype.setupIgcTheme = function() {
            this.setScoreDisplayColor('#2f3448');
            this.setLinesColor('#51566a');
            this.setTextStyle({
                fill: '#ffffff'
            });

            this.setBallColor('#ffffff');
            this.setBackgroundColor('#3f445a');
            this.setBackgroundImage({
                src: '/assets/i-g-c-logo.svg',
                aspectRatio: '1:2',
                stretch: 'height'
            });

            this.players.a.setColor('#63dcfd');
            this.players.a.scoreDisplay.setTextStyle({
                fill: '#63dcfd',
                fontStyle: 'bold',
                fontSize: '80px'
            });

            this.players.b.setColor('#66e07c');
            this.players.b.scoreDisplay.setTextStyle({
                fill: '#66e07c',
                fontStyle: 'bold',
                fontSize: '80px'
            });

            return this;
        };

        Pong.prototype.setupResizeLogicFunc = function() {
            var self = this,
                func = function() {
                    var pongElement = document.getElementById('pong');
                    self._windowRatio = window.innerWidth * window.innerHeight;

                    pongElement.style.height = window.innerHeight + 'px';

                    self.players.a.width = 0.016 * window.innerWidth;
                    self.players.a.height = 0.15 * window.innerHeight;
                    self.players.a.radius = self.players.a.width / 2;
                    self.players.a.refresh();
                    self.players.b.width = 0.016 * window.innerWidth;
                    self.players.b.height = 0.15 * window.innerHeight;
                    self.players.b.radius = self.players.b.width / 2;
                    self.players.b.refresh();

                    self.setBallSpeed(self._windowRatio / 80000);

                    self._defaultPlayerSpeed = self.players.a.speed = self.players.b.speed = self._windowRatio / 2400;

                    if (this.currentGameMode === 'SINGLE_PLAYER') {
                        self.players.b.speed = self._defaultPlayerSpeed / self._playerSpeedHandicap;
                    }

                    self.resize();

                    return self;
                };

            func(); // call for initial resize
            return func;
        }

        Pong.prototype.startSinglePlayer = function() {
            this.currentGameMode = 'SINGLE_PLAYER';
            window.pong.reset();

            this.players.a.resetControls();
            this.players.b.resetControls();

            // player a controls
            this.players.a.addControls({
                'up': 'up',
                'down': 'down',
            });
            this.players.a.touch.enable();
            this.players.a.height = 0.15 * window.innerHeight;

            this.players.b.touch.disable();
            this.players.b.speed = this._defaultPlayerSpeed / this._playerSpeedHandicap;
            this.players.b.height = 0.15 * window.innerHeight;

            this.on('update', this._AI_LOGIC_ONUPDATE = function() {
                // player b / ai logic
                if (this.balls.length > 0) {
                    // prediction of next position is used to prevent choppy movement which is caused by the 
                    // player passing the ball y position and on the next frame going back
                    var ballY = this.balls[0].y;
                    if (this.players.b.y < ballY && this.players.b.predictPosition(1).y < ballY) {
                        this.players.b.move(1);
                    } else if (this.players.b.y > ballY && this.players.b.predictPosition(-1).y > ballY) {
                        this.players.b.move(-1);
                    }
                }
            });

            this.on('point', function(player) {
                this.setBallSpeed(this._windowRatio / 80000);
                this.players.a.setHeight(0.15 * window.innerHeight);
            });

            this.on('hit', function() {
                if (this.hits % 2 === 0) {
                    this.setBallSpeed(this.balls[0].speed * 1.1);
                    this.players.a.setHeight(this.players.a.height * 0.8);
                }
            });

            this.reset();
            this.won = false;
            this.loop.play();
            this.start();
        };

        Pong.prototype.startTwoPlayer = function() {
            this.currentGameMode = 'TWO_PLAYER';
            window.pong.reset();

            this.players.a.resetControls();
            this.players.b.resetControls();

            // player a controls
            this.players.a.addControls({
                'up': 'w',
                'down': 's',
            });
            this.players.a.touch.enable();
            this.players.a.height = 0.15 * window.innerHeight;

            this.players.b.addControls({
                'up': 'up',
                'down': 'down',
            });
            this.players.b.touch.enable();
            this.players.b.speed = this._defaultPlayerSpeed;
            this.players.b.height = 0.15 * window.innerHeight;

            if (this._AI_LOGIC_ONUPDATE !== undefined) {
                // remove on update ai logic
                this.off('update', this._AI_LOGIC_ONUPDATE);
            }

            this.reset();
            this.won = false;
            this.loop.play();
            this.start();
        };

        window.onload = function() {
            var pongElement = document.getElementById('pong');
            window.pong = new Pong(pongElement, {
                screens: {
                    enable: false
                }
            });

            pong._defaultPlayerSpeed = (window.innerWidth * window.innerHeight) / 4000;
            pong._playerSpeedHandicap = 3;

            // pong.showStats(); // show fps counter
            window.onresize = pong.setupResizeLogicFunc();

            pong.on('point', function(player) {
                if (pong.currentGameMode === 'SINGLE_PLAYER' && pong.players.a === player) {
                    var hs = localStorage.getItem('SINGLE_PLAYER_HIGHSCORE');
                    if (hs === null || (hs !== null && player.score > hs)) {
                        localStorage.setItem('SINGLE_PLAYER_HIGHSCORE', player.score);
                        $('.header-highscore-score').text(player.score);
                    }
                }
            });

            pong.setupIgcTheme();
        };
    </script>

    <script>
        var $menu = $('#menu');

        function toggleMenu() {
            if ($menu.hasClass('hidden')) {
                // if menu is closed
                pong.pause()
                $menu.removeClass('hidden');

                var $closeBtn = $('button.close-btn');
                if (pong.started === true) {
                    $closeBtn.show();
                } else {
                    $closeBtn.hide();
                }
            } else if (pong.started === true) {
                // if menu is open
                pong.resume()
                $menu.addClass('hidden');
                $('button.close-btn').show();
            }
        }

        $(document).ready(function() {
            var hs = localStorage.getItem('SINGLE_PLAYER_HIGHSCORE');
            $('.header-highscore-score').text(hs !== null ? hs : 0);

            $('.header-logo').click(function() {
                toggleMenu();
            });

            $('#close-menu-btn').click(function() {
                // since the close button is always visible when the modal is visible 
                // this will always go through the modal hiding procedure
                toggleMenu();
            });

            $(document).keyup(function(e) {
                if (e.keyCode === 27) { // esc
                    toggleMenu();
                }
            });

            $('#singlep-menu-btn').click(function() {
                $menu.addClass('hidden');
                // start game in single player
                window.pong.startSinglePlayer();
                $('.header-highscore').css('visibility', 'visible');
            });

            $('#twop-menu-btn').click(function() {
                $menu.addClass('hidden');
                // start game in 2 player
                window.pong.startTwoPlayer();
                $('.header-highscore').css('visibility', 'hidden');
            });
        });

        function showMenu() {
            $menu.removeClass('hidden');
        };
    </script>
</body>

</html>